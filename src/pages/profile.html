<section class="glass" style="margin:12px;padding:14px">

  <h3 style="margin:0 0 8px 0">Profile</h3>

  <div class="glass" style="padding:12px;display:flex;gap:10px;align-items:center">
    <img id="p-avatar" style="width:64px;height:64px;border-radius:50%" />
    <div>
      <h4 id="p-name" style="margin:0">Loadingâ€¦</h4>
      <p id="p-username" style="margin:0;font-size:14px;opacity:.8">@â€”</p>
      <small id="p-id" style="opacity:.6">ID: â€”</small>
      <p id="coins" style="margin-top:6px"><b>Coins:</b> â€”</p>
    </div>
  </div>

  <div id="char-card" class="glass" style="padding:12px;margin-top:12px">
    Loading...
  </div>

  <button id="dailyBtn"
          style="margin-top:12px;width:100%;padding:10px;border:none;border-radius:12px;background:#2ecc71;color:white">
    ğŸ Claim Daily Reward
  </button>

</section>

<script>
const tg = window.Telegram.WebApp;
tg.expand();   // full height UI

let USER = tg.initDataUnsafe?.user;   // <- REAL Telegram user here

async function loadProfile() {

  if (!USER) {
    document.getElementById("char-card").innerHTML =
      "âš ï¸ Please open inside Telegram.";
    return;
  }

  const payload = {
    telegramId: USER.id.toString(),
    username: USER.username || "",
    fullname: USER.first_name + (USER.last_name ? " " + USER.last_name : "")
  };

  const res = await fetch("/api/users", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const data = await res.json();

  // USER INFO UI
  document.getElementById("p-name").innerText = data.user.fullname;
  document.getElementById("p-username").innerText =
    data.user.username ? "@" + data.user.username : "â€”";
  document.getElementById("p-id").innerText = "ID: " + data.user.telegramId;

  // REAL Telegram profile photo (fallback if none)
  document.getElementById("p-avatar").src =
    USER.photo_url ||
    "https://api.dicebear.com/7.x/thumbs/svg?seed=" + data.user.telegramId;

  document.getElementById("coins").innerHTML =
    "<b>Coins:</b> " + (data.user.coins || 0);

  // CHARACTER UI
  const c = data.character;

  document.getElementById("char-card").innerHTML = `
    <div style="display:flex;gap:10px;align-items:center">
      <img src="${c.imageUrl}"
           style="width:90px;height:90px;border-radius:20px;object-fit:cover">
      <div>
        <h4 style="margin:0">${c.name}</h4>
        <small>Level ${c.level}</small>
      </div>
    </div>
    <hr>
    <p>â¤ï¸ HP: <b>${c.stats.hp}</b></p>
    <p>âš” Attack: <b>${c.stats.attack}</b></p>
    <p>ğŸ›¡ Defense: <b>${c.stats.defense}</b></p>
    <p>âš¡ Speed: <b>${c.stats.speed}</b></p>`;
}

async function claimDaily() {
  const res = await fetch("/api/daily", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ telegramId: USER.id.toString() })
  });

  const data = await res.json();

  if (data.ok) {
    alert("ğŸ Claimed! Coins: " + data.coins);
    loadProfile();
  } else {
    alert("â³ wait " + data.cooldown + " minutes");
  }
}

document.getElementById("dailyBtn").onclick = claimDaily;

loadProfile();
</script>