<header class="glass header">
  <div style="display:flex;align-items:center;gap:12px">

    <img id="avatar"
         style="width:64px;height:64px;border-radius:18px;border:2px solid rgba(255,255,255,.5)">

    <div style="flex:1">
      <h3 id="name" style="margin:0 0 2px 0">Player</h3>
      <p id="username" style="margin:0;font-size:14px;opacity:.8">@username</p>

      <!-- coins badge -->
      <div id="coinsBadge"
           style="margin-top:6px;display:inline-block;padding:4px 10px;border-radius:14px;
                  background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.25);
                  font-size:13px">
        üí∞ <span id="coinsMini">0</span>
      </div>

      <!-- XP bar -->
      <div style="margin-top:6px;width:100%;height:6px;border-radius:6px;
                  background:rgba(255,255,255,.18)">
        <div id="xpBar"
             style="height:100%;width:30%;border-radius:6px;
                    background:linear-gradient(90deg,#4caf50,#8bc34a)">
        </div>
      </div>

      <small id="uid" style="opacity:.65">ID ‚Äî</small>
    </div>

  </div>
</header>
<section class="glass" style="margin:12px;padding:14px">

  <h3 style="margin-bottom:10px">Profile</h3>

  <!-- INFO CARD -->
  <div class="glass" style="padding:12px;display:flex;gap:10px;align-items:center">
    <img id="p-avatar" style="width:64px;height:64px;border-radius:50%" />
    <div>
      <h4 id="p-name" style="margin:0">Loading‚Ä¶</h4>
      <p id="p-username" style="margin:0;font-size:14px;opacity:.8">@‚Äî</p>
      <small id="p-id" style="opacity:.7">ID: ‚Äî</small>
      <p id="coins" style="margin-top:6px"><b>Coins:</b> ‚Äî</p>
    </div>
  </div>

  <!-- CHARACTER -->
  <div id="char-card" class="glass" style="padding:12px;margin-top:12px">
    Loading character‚Ä¶
  </div>

  <button id="dailyBtn"
    style="margin-top:12px;width:100%;padding:10px;border:none;border-radius:14px;background:#2ecc71;color:white">
    üéÅ Claim Daily Reward
  </button>

</section>

<script>
const tg = window.Telegram?.WebApp;
tg?.expand();

let AUTH = null;

async function loadProfile(){

  if(!tg?.initData){
    document.getElementById("char-card").innerHTML =
      "‚ö†Ô∏è Open inside Telegram WebApp.";
    return;
  }

  // secure login request
  const res = await fetch("/api/auth", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ initData: tg.initData })
  });

  const data = await res.json();
  AUTH = data;

  if(!data.ok){
    document.getElementById("char-card").innerHTML = "‚ùå Auth failed.";
    return;
  }

  const user = data.user;

  document.getElementById("p-name").innerText = user.fullname;
  document.getElementById("p-username").innerText =
    user.username ? "@" + user.username : "‚Äî";
  document.getElementById("p-id").innerText = "ID: " + user.telegramId;

  document.getElementById("p-avatar").src =
    tg?.initDataUnsafe?.user?.photo_url ||
    "https://api.dicebear.com/7.x/thumbs/svg?seed=" + user.telegramId;

  document.getElementById("coinsMini").innerText = (user.coins || 0);
  const c = data.character;
  // basic XP bar percent (demo: level * 10)
  const percent = Math.min(100, c.level * 10);
  document.getElementById("xpBar").style.width = percent + "%"; 
     document.getElementById("char-card").innerHTML = `
    <div style="display:flex;gap:10px;align-items:center">
      <img src="${c.imageUrl}"
           style="width:90px;height:90px;border-radius:18px;object-fit:cover">
      <div>
        <h4 style="margin:0">${c.name}</h4>
        <small>Level ${c.level}</small>
      </div>
    </div>

    <hr>

    <p>‚ù§Ô∏è HP: <b>${c.stats.hp}</b></p>
    <p>‚öî Attack: <b>${c.stats.attack}</b></p>
    <p>üõ° Defense: <b>${c.stats.defense}</b></p>
    <p>‚ö° Speed: <b>${c.stats.speed}</b></p>
  `;
}

async function claimDaily(){
  if(!AUTH) return;

  const res = await fetch("/api/daily", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ telegramId: AUTH.user.telegramId })
  });

  const data = await res.json();

  if(data.ok){
    alert("üéÅ Claimed! Coins: " + data.coins);
    loadProfile();
  } else {
    alert("‚è≥ wait " + data.cooldown + " minutes");
  }
}

document.getElementById("dailyBtn").onclick = claimDaily;

loadProfile();
</script>